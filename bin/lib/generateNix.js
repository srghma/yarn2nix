const R = require('ramda')

const urlToName = require('./urlToName')

// fetchgit examples:
// 1)
//
// "shell-quote@git+https://github.com/srghma/node-shell-quote.git#without_unlicenced_jsonify":
//   version "1.6.0"
//   resolved "git+https://github.com/srghma/node-shell-quote.git#1234commit"
//
// to
//
// builtins.fetchGit {
//   url = "https://github.com/srghma/node-shell-quote.git";
//   ref = "without_unlicenced_jsonify";
//   rev = "1234commit";
// }
//
// 2)
//
// "@graphile/plugin-supporter@git+https://1234user:1234pass@git.graphile.com/git/users/1234user/postgraphile-supporter.git":
//   version "0.6.0"
//   resolved "git+https://1234user:1234pass@git.graphile.com/git/users/1234user/postgraphile-supporter.git#1234commit"
//
// to
//
// builtins.fetchGit {
//   url = "https://1234user:1234pass@git.graphile.com/git/users/1234user/postgraphile-supporter.git";
//   ref = "master";
//   rev = "1234commit";
// }
//
// 3)
//
// "globby@git://github.com/nexe/globby.git#de057b69c2bca74391bfd913ed0145ce4e42563a":
//   version "8.0.1"
//   resolved "git://github.com/nexe/globby.git#de057b69c2bca74391bfd913ed0145ce4e42563a"
//
// to
//
// builtins.fetchGit {
//   url = "https://github.com/nexe/globby.git";
//   ref = "master";
//   rev = "de057b69c2bca74391bfd913ed0145ce4e42563a";
// }

function fetchgit(fileName, url, rev, branch) {
  return `    {
      name = "${fileName}";
      path =
        let
          repo = builtins.fetchGit {
            url = "${url}";
            ref = "${branch}";
            rev = "${rev}";
          };
        in
          runCommandNoCC "${fileName}" { buildInputs = [gnutar]; } ''
            # Set u+w because tar-fs can't unpack archives with read-only dirs
            # https://github.com/mafintosh/tar-fs/issues/79
            tar cf $out --mode u+w -C \${repo} .
          '';
    }`
}

// fetchurl examples:
// 1)
//
// "nexe@github:anmonteiro/nexe#master":
//   version "3.0.0-beta.5"
//   resolved "https://codeload.github.com/anmonteiro/nexe/tar.gz/142338ede69c3828c8a3c9fa7bacd4850762e4a1"
//
// to
//
// fetchurl {
//   name = "anmonteiro-nexe-142338ede69c3828c8a3c9fa7bacd4850762e4a1";
//   url = "https://codeload.github.com/anmonteiro/nexe/tar.gz/142338ede69c3828c8a3c9fa7bacd4850762e4a1";
//   rev = "<sha1 generated by getSha1>";
// }

function fetchurl(fileName, url, sha) {
  return `    {
      name = "${fileName}";
      path = fetchurl {
        name = "${fileName}";
        url  = "${url}";
        sha1 = "${sha}";
      };
    }`
}

function fetchLockedDep(pkg) {
  const { nameWithVersion, resolved } = pkg

  if (!resolved) {
    console.error(
      `yarn2nix: can't find "resolved" field for package ${nameWithVersion}, you probably required it using "file:...", this feature is not supported, ignoring`,
    )
    return ''
  }

  const [url, sha1OrRev] = resolved.split('#')

  const fileName = urlToName(url)

  const isGitDep = url.startsWith('git+https://') || url.startsWith('git://')

  if (isGitDep) {
    const rev = sha1OrRev

    const [_, branch] = nameWithVersion.split('#')

    const urlForGit = url.replace('git+https://', 'https://').replace('git://', 'https://')

    return fetchgit(fileName, urlForGit, rev, branch || 'master')
  }

  const sha = sha1OrRev

  return fetchurl(fileName, url, sha)
}

const HEAD = `
{ fetchurl, linkFarm, runCommandNoCC, gnutar }: rec {
  offline_cache = linkFarm "offline" packages;
  packages = [
`.trim()

// Object -> String
function generateNix(pkgs) {
  const nameWithVersionAndPackageNix = R.map(fetchLockedDep, pkgs)

  const packagesDefinition = R.join(
    '\n',
    R.values(nameWithVersionAndPackageNix),
  )

  return R.join('\n', [HEAD, packagesDefinition, '  ];', '}'])
}

module.exports = generateNix
